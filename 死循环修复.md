# AI 死循环问题修复

## 问题描述

游戏中出现死循环：
- 所有玩家都显示"已出完"
- 但游戏没有结束
- AI 之间疯狂互相抽牌
- 控制台日志无限重复

---

## 问题原因

### 死循环触发条件

1. **所有玩家都被标记为 `out = true`**
2. **但 `game.gameOver = false`**（游戏未结束）
3. **`runAiLoop` 调用 `advanceTurn`**
4. **`advanceTurn` 找不到活跃玩家，设置 `gameOver = true`**
5. **但 `runAiLoop` 已经在递归调用中**，死循环

### 流程图

```
runAiLoop()
  ↓
current.out? → 是
  ↓
advanceTurn() → nextActivePlayerIndex()
  ↓
找到下一个玩家？
  ↓ 否（所有人都 out）
设置 gameOver = true
  ↓
runAiLoop() ← 但还在递归调用栈中！
  ↓
检查 gameOver → 应该退出，但已经在循环中
  ↓
死循环！
```

---

## 解决方案

### 在 `runAiLoop` 开始时添加检测

```javascript
function runAiLoop(game, settings) {
  if (!game || game.gameOver) return;

  // 🆕 死循环检测：如果所有玩家都出局，强制结束游戏
  const allOut = game.players.every(p => p.out);
  if (allOut) {
    console.log('[死循环检测] 所有玩家都已出局，强制结束游戏');
    game.gameOver = true;
    const loser = window.Game.findJokerHolder(game.players);
    game.winnerText = loser
      ? `游戏结束：${loser.name} 手里留着"王八牌"，失败！`
      : "游戏结束";
    renderAll(game, settings);
    return; // ✅ 立即退出，不继续递归
  }

  // ... 正常逻辑
}
```

### 关键改进

1. **提前检测** - 在任何逻辑之前检查所有玩家是否出局
2. **强制结束** - 设置 `gameOver = true` 并显示结束界面
3. **立即退出** - `return` 不继续递归

---

## 根本问题：为什么所有玩家都 `out = true`？

这可能是一个 **Bug**：

### 可能的原因

1. **大王卡丢失**：
   - 大王卡应该在某人手里
   - 但可能被错误地配对或移除了

2. **`out` 标记错误**：
   - `out = hand.length === 0` 是正确的
   - 但如果手里有大王卡，`out` 应该是 `false`
   - 可能是某个地方错误地设置了 `out = true`

3. **配对逻辑 Bug**：
   - 大王卡不应该能配对
   - 但可能被 `discardAllPairsInPlace` 错误移除了

### 需要检查

打开控制台，输入：

```javascript
// 检查所有玩家的状态
game.players.forEach((p, i) => {
  console.log(`玩家${i}:`, {
    name: p.name,
    out: p.out,
    handLength: p.hand.length,
    hand: p.hand.map(c => `${c.id}(${c.type})`)
  });
});

// 检查大王卡在哪里
game.players.forEach((p, i) => {
  const hasJoker = p.hand.some(c => c.type === 'joker');
  if (hasJoker) console.log(`大王卡在：玩家${i} ${p.name}`);
});
```

---

## 临时解决方案

死循环检测已添加，即使出现 Bug 也会强制结束游戏，不会卡死。

---

## 长期解决方案

需要找到**为什么所有玩家都 `out = true` 但手里还有牌**的根本原因。

可能的修复：
1. **检查 `discardAllPairsInPlace`** - 确保不会错误移除大王卡
2. **修复 `out` 标记逻辑** - 确保只有 `hand.length === 0` 时才设置
3. **游戏结束判定提前** - 在每次抽牌/出牌后立即检查

---

**更新时间**：2026-01-12
**版本**：v5.3 - Infinite Loop Detection
**状态**：⚠️ 临时修复，需要进一步调查根本原因
