# A/B 卡平衡调试工具

## 功能说明

在游戏界面上，每个玩家的手牌数量显示现在会包含 **A/B 分布信息**：

```
手牌 7 (A:1 B:6 -5)
     ↑   ↑  ↑  ↑
     总数 A卡 B卡 差异
```

---

## 显示格式

### 格式说明

```
手牌 {总数} (A:{A卡数量} B:{B卡数量} {差异})
```

**差异**：
- `+N`：A 卡比 B 卡多 N 张（例如 `+3`）
- `-N`：B 卡比 A 卡多 N 张（例如 `-5`）
- `0`：A 卡和 B 卡数量相同

### 示例

| 显示 | 含义 |
|------|------|
| `手牌 5 (A:3 B:2 +1)` | 5 张牌，3 张 A 卡（图片），2 张 B 卡（文字），A 卡多 1 张 |
| `手牌 7 (A:1 B:6 -5)` | 7 张牌，1 张 A 卡（图片），6 张 B 卡（文字），B 卡多 5 张 ❌ 严重不平衡 |
| `手牌 4 (A:2 B:2 0)` | 4 张牌，2 张 A 卡，2 张 B 卡，完美平衡 ✅ |
| `已出完` | 玩家已出完所有牌 |

---

## 平衡评估标准

| 差异范围 | 评估 | 说明 |
|---------|------|------|
| **0** | ✅ 完美平衡 | A 卡和 B 卡数量相同 |
| **±1** | ✅ 良好平衡 | 轻微差异，可接受 |
| **±2** | ⚠️ 轻度不平衡 | 开始触发平衡机制 |
| **±3** | ⚠️ 中度不平衡 | 需要优先抽对侧卡牌 |
| **±4+** | ❌ 严重不平衡 | 很难配对，急需平衡 |

---

## 平衡机制触发条件

### AI 抽牌

**触发条件**：`diff > 1` 或 `diff < -1`

```javascript
const needSide = diff > 1 ? "B" : (diff < -1 ? "A" : null);

// 差异 > +1：需要 B 卡
// 差异 < -1：需要 A 卡
// 差异在 [-1, 1]：均衡，不需要特殊处理
```

**示例**：
- `A:5 B:2 +3` → 触发，需要 B 卡
- `A:3 B:2 +1` → 不触发，差异可接受
- `A:1 B:6 -5` → 触发，需要 A 卡

### 玩家抽牌（实时替换）

**触发条件**：
1. 抽到的牌不能匹配
2. 实时替换概率（60-85%）
3. 优先选择能平衡 A/B 的牌（优先级 +10）

---

## 使用方法

### 1. 实时监控

在游戏过程中，观察每个玩家的 A/B 分布：

```
你:   手牌 7 (A:1 B:6 -5)  ❌ B 卡太多
AI1:  手牌 5 (A:3 B:2 +1)  ✅ 相对平衡
AI2:  手牌 6 (A:5 B:1 +4)  ❌ A 卡太多
AI3:  手牌 4 (A:2 B:2 0)   ✅ 完美平衡
```

### 2. 验证平衡机制

#### 测试玩家抽牌

1. 当前手牌：`A:1 B:6 -5`（需要 A 卡）
2. 点击上家手牌，打开抽牌界面
3. 点击卡背，观察抽到的牌
4. **预期**：大概率抽到 A 卡（图片卡）
5. 抽牌后手牌变成：`A:2 B:6 -4`（差异减小）

#### 测试 AI 抽牌

1. AI2 手牌：`A:5 B:1 +4`（需要 B 卡）
2. 轮到 AI2，观察控制台日志：
   ```
   [AI抽牌] AI2 手牌 A:5 B:1 差异:4 需要:B
   [AI抽牌] 候选牌:7 前30%:3 选中优先级:11
   ```
3. **预期**：AI2 优先抽 B 卡（文字卡）
4. 抽牌后 AI2 手牌变成：`A:5 B:2 +3`（差异减小）

### 3. 长期观察

玩 5-10 轮后：
- **所有玩家的差异**应该逐渐收敛到 **±2 以内**
- 不应该出现长期严重不平衡（±5 以上）
- 如果仍然严重不平衡，说明平衡机制有问题

---

## 调试日志

### 控制台输出

打开浏览器控制台（F12），可以看到详细的平衡日志：

#### 玩家抽牌

```
[平衡] 玩家手牌 A:1 B:6 差异:-5 需要:A
[实时替换] 第3张牌不可匹配，寻找替换...
[实时替换] 成功！换入 A 侧牌 4（优先级:10）
```

#### AI 抽牌

```
[AI抽牌] AI1 手牌 A:4 B:1 差异:3 需要:B
[AI抽牌] 候选牌:8 前30%:3 选中优先级:16
→ AI1 抽到能平衡 + 能配对的 B 卡
```

---

## 已知问题和改进方向

### 当前限制

1. **发牌阶段**：
   - 发牌是随机的，不考虑 A/B 平衡
   - 可能导致发牌后就严重不平衡

2. **平衡速度**：
   - 每次抽牌只能改善 1 张
   - 严重不平衡（±5）需要多轮才能恢复

3. **AI 之间**：
   - AI 互相抽牌时也有平衡机制
   - 但如果所有 AI 都偏向同一侧，可能无法平衡

### 可能的改进

1. **发牌阶段平衡**：
   - 在 `dealConstrained22Pairs` 中，确保每个玩家初始的 A/B 相对平衡
   - 例如：4 对牌 → 2 对 A 卡 + 2 对 B 卡

2. **更激进的平衡**：
   - 将阈值从 `diff > 1` 改为 `diff > 0`（任何不平衡都触发）
   - 或者提高平衡优先级（从 +10 改为 +20）

3. **全局平衡**：
   - 检测所有玩家的 A/B 分布
   - 如果整体不平衡，强制交换某些牌

**需要我实现这些改进吗？**

---

## 测试建议

1. **刷新页面，重新开始游戏**
2. **观察初始发牌后的 A/B 分布**
3. **玩几轮，观察差异是否逐渐减小**
4. **如果仍然严重不平衡，告诉我具体情况**

---

**更新时间**：2026-01-12
**版本**：v5.1 - A/B Balance Debug Display
