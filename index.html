<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>æŠ½ä¹Œé¾Ÿï¼ˆå„¿ç«¥è‹±è¯­å­¦ä¹ ç‰ˆï¼‰</title>
    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="title">
          <h1>OLD MAID Â· æŠ½ä¹Œé¾Ÿï¼ˆå„¿ç«¥è‹±è¯­å­¦ä¹ ç‰ˆï¼‰<span id="levelIndicator" style="margin-left: 12px; font-size: 14px; color: rgba(255,255,255,0.7);"></span></h1>
          <div class="sub">è‹±æ–‡å›¾ç‰‡ â†” åŠ¨ç‰©å›¾ç‰‡é…å¯¹ Â· é€†æ—¶é’ˆè½®æµ Â· æŠ½ä¸Šå®¶ç‰Œ Â· åŒ¹é…è§„åˆ™ï¼šåŠ¨ç‰©å›¾ç‰‡å’Œå¯¹åº”è‹±æ–‡</div>
        </div>
        <div class="btnRow">
          <button id="btnRestart" type="button" title="è¿”å›è®¾ç½®">è¿”å›è®¾ç½®</button>
          <button id="btnEndTurn" class="primary" type="button" title="ç»“æŸæœ¬å›åˆ">ç»“æŸå›åˆ</button>
          <button id="btnTune" type="button" title="å¸ƒå±€è°ƒå‚">è°ƒå¸ƒå±€</button>
          <button id="btnFullscreen" type="button" title="å…¨å±/é€€å‡ºå…¨å±">å…¨å±</button>
        </div>
      </div>

      <div id="setup" class="panel">
        <div class="setupGrid">
          <div class="field">
            <label>å›ºå®š 4 äººå±€ï¼ˆä½  + 3 ä¸ª AIï¼‰</label>
            <div class="row">
              <button id="btnStart" class="primary" type="button">å¼€å§‹æ¸¸æˆ</button>
            </div>
          </div>

          <div class="field">
            <label>æœ¬å±€ä½¿ç”¨é…å¯¹ï¼š<span id="pairCountLabel">22</span> å¯¹ï¼ˆæ€»ç‰Œæ•° <span id="totalCardLabel">45</span> å¼ ï¼‰</label>
            <div class="row">
              <input id="pairCount" type="range" min="3" max="26" step="1" value="22" />
              <input id="pairCountNum" type="number" min="3" max="26" step="1" value="22" aria-label="é…å¯¹æ•°é‡" />
            </div>
          </div>

          <div class="field">
            <label>AI è®¾ç½®</label>
            <div class="row">
              <label style="display:flex;align-items:center;gap:8px;">
                <input id="autoNextToggle" type="checkbox" checked />
                AI å›åˆè‡ªåŠ¨è¿›è¡Œï¼ˆæ¨èå¼€å¯ï¼‰
              </label>
            </div>
          </div>

          <div class="footerNote">
            è§„åˆ™ï¼š<br>
            1. è½®åˆ°ä½ æ—¶ä½ éœ€è¦è‡ªå·±åœ¨æ‰‹ç‰Œé‡Œæ‰¾åŠ¨ç‰©ç‰Œå’Œä¸å®ƒå¯¹åº”çš„è‹±æ–‡ç‰Œï¼ˆå¦‚ï¼šè›‡ç‰Œå’Œsnakeç‰Œï¼Œè¿ç»­ç‚¹å‡ºè¿™ä¸¤å¼ ï¼‰ï¼Œé€‰ä¸­ä¸¤å¼ åç‚¹"åŒ¹é…å‡ºç‰Œ"ã€‚<br>
            2. ä¸èƒ½ç»§ç»­åŒ¹é…åï¼Œç‚¹å‡»å±•å¼€ä¸Šå®¶æ‰‹ç‰Œï¼ˆå·¦æ‰‹è¾¹ï¼‰æŠ½ 1 å¼ åŠ å…¥æ‰‹ç‰Œï¼›<br>
            3. æ‰€æœ‰æ“ä½œç»“æŸåç‚¹å‡»"ç»“æŸå›åˆ"<br>
            4. ä¹Œé¾Ÿç‰Œä¸å¯ä¸ä»»ä½•ç‰ŒåŒ¹é…ï¼Œæœ€åæ‰‹ä¸­å‰©ä½™ä¹Œé¾Ÿç‰Œæ—¶ï¼Œåˆ¤è´Ÿ
          </div>
        </div>
      </div>

      <div id="game" class="panel gamePanel hidden">
        <div class="tableBg" aria-label="ç‰Œæ¡Œ">
          <div class="zone zone-top">
            <div class="zoneHead">
              <div id="pTopName" class="zoneName"></div>
              <div id="pTopCount" class="zoneCount"></div>
            </div>
            <div id="pTopHand" class="seatHand"></div>
          </div>

          <div class="zone zone-left">
            <div class="zoneHead">
              <div id="pLeftName" class="zoneName"></div>
              <div id="pLeftCount" class="zoneCount"></div>
            </div>
            <div id="pLeftHand" class="seatHand"></div>
          </div>

          <div class="zone zone-right">
            <div class="zoneHead">
              <div id="pRightName" class="zoneName"></div>
              <div id="pRightCount" class="zoneCount"></div>
            </div>
            <div id="pRightHand" class="seatHand"></div>
          </div>

          <div class="zone zone-bottom">
            <div class="zoneHead">
              <div id="pBottomName" class="zoneName"></div>
              <div id="pBottomCount" class="zoneCount"></div>
            </div>
            <div id="pBottomHand" class="yourHand"></div>
          </div>

          <div class="zone zone-center">
            <div id="discardPile" class="pileCards" aria-label="å¼ƒç‰Œå †"></div>
            <div id="discardCount" class="pileCount"></div>
          </div>

          <!-- Bottom-center action buttons (image based) -->
          <div class="uiActionBar" aria-label="æ“ä½œæŒ‰é’®">
            <button id="btnHintImg" class="uiBtn" type="button" aria-label="æç¤º">
              <img src="./assets/ui_buttons/hint.png" alt="æç¤º" draggable="false" />
            </button>
            <button id="btnMatchImg" class="uiBtn uiBtnMatch" type="button" aria-label="åŒ¹é…å‡ºç‰Œ">
              <img src="./assets/ui_buttons/match.png" alt="åŒ¹é…å‡ºç‰Œ" draggable="false" />
            </button>
            <button id="btnEndTurnImg" class="uiBtn" type="button" aria-label="ç»“æŸå›åˆ">
              <img src="./assets/ui_buttons/endturn.png" alt="ç»“æŸå›åˆ" draggable="false" />
            </button>
          </div>
        </div>

        <div id="message" class="msg" aria-live="polite"></div>
        <div id="choiceRow" class="choiceRow hidden">
          <button id="btnTryMatch" class="primary" type="button">å°è¯•é…å¯¹å¹¶ä¸¢å¼ƒ</button>
          <button id="btnClearSelect" type="button">å–æ¶ˆé€‰æ‹©</button>
        </div>

        <div id="drawOverlay" class="drawOverlay hidden" role="dialog" aria-modal="true">
          <div class="drawOverlayInner">
            <button id="btnDrawClose" class="drawClose" type="button" aria-label="å…³é—­">å…³é—­</button>
            <div class="drawHint">ä»ä¸Šå®¶æ‰‹ç‰Œä¸­é€‰ä¸€å¼ æŠ½èµ°</div>
            <div id="drawRow" class="drawRow" aria-label="ä¸Šå®¶å±•å¼€æ‰‹ç‰Œ"></div>
            <div id="drawScroll" class="drawScroll hidden" aria-hidden="true">
              <div id="drawThumb" class="drawThumb"></div>
            </div>
          </div>
        </div>

        <div id="endOverlay" class="endOverlay hidden" role="dialog" aria-modal="true">
          <div class="endCard">
            <div id="endTitle" class="endTitle"></div>
            <div id="endSubtitle" class="endSubtitle"></div>
            <div class="endActions">
              <button id="btnNextLevel" class="primary" type="button" style="display: none;">è¿›å…¥ä¸‹ä¸€å…³</button>
              <button id="btnPlayAgain" class="primary" type="button">é‡æ–°æŒ‘æˆ˜</button>
              <button id="btnBackToSetup" type="button">è¿”å›è®¾ç½®</button>
            </div>
          </div>
        </div>

        <div id="tunerPanel" class="tunerPanel hidden" role="dialog" aria-modal="true">
          <div class="tunerHeader">
            <div class="tunerTitle">å¸ƒå±€è°ƒå‚</div>
            <button id="btnTuneClose" type="button">å…³é—­</button>
          </div>
          <div class="tunerBody">
            <div class="tunerHint">æ‹–åŠ¨æ»‘æ¡å®æ—¶è°ƒæ•´ 5 ä¸ªåŒºåŸŸçš„ä½ç½®/å°ºå¯¸ï¼ˆç™¾åˆ†æ¯”ï¼‰ï¼Œè‡ªåŠ¨ä¿å­˜ã€‚</div>
            <div id="tunerControls" class="tunerControls"></div>
          </div>
          <div class="tunerFooter">
            <button id="btnTuneReset" type="button">æ¢å¤é»˜è®¤</button>
            <button id="btnTuneImport" type="button">å¯¼å…¥å‚æ•°</button>
            <button id="btnTuneCopy" class="primary" type="button">å¤åˆ¶å‚æ•°</button>
          </div>
        </div>

        <!-- A/B å¹³è¡¡è°ƒè¯•é¢æ¿ -->
        <div id="abDebugPanel" class="abDebugPanel hidden">
          <div class="abDebugHeader">A/B åˆ†å¸ƒ</div>
          <div id="abDebugContent" class="abDebugContent"></div>
        </div>
      </div>
    </div>

    <!-- Three.js (CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- deck -->
    <script src="./deck/image_pairs.js"></script>
    <!-- Joker summon effect -->
    <script src="./src/joker-summon.js"></script>
    <!-- app (no modules so file:// works) -->
    <script src="./src/game.js"></script>
    <script src="./src/ui.js"></script>
    <script>
      // å›¾ç‰‡é¢„åŠ è½½åŠŸèƒ½
      function preloadImages(imagePairs, onProgress, onComplete) {
        const images = [];

        // æ”¶é›†æ‰€æœ‰éœ€è¦åŠ è½½çš„å›¾ç‰‡URL
        imagePairs.forEach(pair => {
          images.push(pair.A);
          images.push(pair.B);
        });

        // æ·»åŠ æ¸¸æˆæ ¸å¿ƒå›¾ç‰‡
        images.push('./assets/joker.png');
        images.push('./assets/card-back.png');
        images.push('./assets/table.png');

        // æ·»åŠ UIæŒ‰é’®å›¾ç‰‡
        images.push('./assets/ui_buttons/hint.png');
        images.push('./assets/ui_buttons/match.png');
        images.push('./assets/ui_buttons/endturn.png');
        images.push('./assets/ui_buttons/hand-count.png');
        images.push('./assets/ui_buttons/hint-hand.png');
        images.push('./assets/ui_buttons/round-start-panel.png');

        let loaded = 0;
        const total = images.length;
        const imageElements = [];

        images.forEach((src, index) => {
          const img = new Image();
          img.onload = img.onerror = () => {
            loaded++;
            if (onProgress) {
              onProgress(loaded, total, Math.round((loaded / total) * 100));
            }
            if (loaded === total && onComplete) {
              onComplete();
            }
          };
          img.src = src;
          imageElements.push(img);
        });
      }

      // æ˜¾ç¤ºåŠ è½½ç•Œé¢
      function showLoadingScreen() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'imageLoader';
        loadingDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: radial-gradient(ellipse at center, rgba(0,10,25,0.95) 0%, rgba(0,0,0,0.98) 100%);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 99999;
          font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
        `;

        loadingDiv.innerHTML = `
          <div style="text-align: center;">
            <h2 style="color: rgba(255,255,255,0.9); font-size: 24px; margin-bottom: 30px;">
              ğŸ¢ æ­£åœ¨åŠ è½½å¡ç‰Œ...
            </h2>
            <div style="width: 300px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
              <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #7aa2ff, #2bd576); transition: width 0.3s;"></div>
            </div>
            <div id="progressText" style="color: rgba(255,255,255,0.7); font-size: 14px;">
              0 / 0 (0%)
            </div>
          </div>
        `;

        document.body.appendChild(loadingDiv);
        return loadingDiv;
      }

      if (!window.Game || !window.initUi) {
        alert("ç¨‹åºåŠ è½½å¤±è´¥ï¼šsrc/game.js æˆ– src/ui.js æœªåŠ è½½ã€‚");
      } else {
        const pairs = window.__IMAGE_PAIRS__ || [];

        // æ˜¾ç¤ºåŠ è½½ç•Œé¢
        const loader = showLoadingScreen();
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
        preloadImages(
          pairs,
          (loaded, total, percent) => {
            // æ›´æ–°è¿›åº¦
            progressBar.style.width = percent + '%';
            progressText.textContent = `${loaded} / ${total} (${percent}%)`;
          },
          () => {
            // åŠ è½½å®Œæˆï¼Œæ·¡å‡ºåŠ è½½ç•Œé¢
            loader.style.transition = 'opacity 0.5s';
            loader.style.opacity = '0';
            setTimeout(() => {
              loader.remove();
              // åˆå§‹åŒ–æ¸¸æˆ
              window.initUi(pairs);
            }, 500);
          }
        );
      }

      // å…¨å±åŠŸèƒ½ï¼ˆå…¼å®¹ Safariï¼‰
      const btnFullscreen = document.getElementById('btnFullscreen');
      if (btnFullscreen) {
        btnFullscreen.addEventListener('click', () => {
          const elem = document.documentElement;
          const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;

          if (!isFullscreen) {
            // è¿›å…¥å…¨å±ï¼ˆå…¼å®¹ Safariï¼‰
            const requestFullscreen = elem.requestFullscreen || elem.webkitRequestFullscreen;
            if (requestFullscreen) {
              requestFullscreen.call(elem).then(() => {
                btnFullscreen.textContent = 'é€€å‡ºå…¨å±';
              }).catch(err => {
                console.warn('æ— æ³•è¿›å…¥å…¨å±:', err);
              });
            }
          } else {
            // é€€å‡ºå…¨å±ï¼ˆå…¼å®¹ Safariï¼‰
            const exitFullscreen = document.exitFullscreen || document.webkitExitFullscreen;
            if (exitFullscreen) {
              exitFullscreen.call(document).then(() => {
                btnFullscreen.textContent = 'å…¨å±';
              }).catch(err => {
                console.warn('æ— æ³•é€€å‡ºå…¨å±:', err);
              });
            }
          }
        });

        // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–ï¼ˆå…¼å®¹ Safariï¼‰
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);

        function updateFullscreenButton() {
          const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;
          btnFullscreen.textContent = isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±';
        }
      }

      // ç§»åŠ¨ç«¯ï¼šç§»é™¤è‡ªåŠ¨å…¨å±åŠŸèƒ½ï¼Œé¿å… Safari é”™è¯¯
      // Safari åœ¨ç§»åŠ¨ç«¯ä¸æ”¯æŒå…¨å± API
    </script>
  </body>
</html>

