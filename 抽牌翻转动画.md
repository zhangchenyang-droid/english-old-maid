# 抽牌翻转动画

## 动画效果

点击抽牌界面的卡背后：
1. **原地翻转**：卡背（0°）→ 正面（180°）
2. **显示内容**：翻转过程中展示卡牌图片
3. **关闭界面**：翻转完成后关闭抽牌界面
4. **飞向手牌**：卡牌从原位置飞向玩家手牌

**关键**：使用**同一个元素**（按钮 `b`），不克隆。

---

## 实现原理

### 双面卡结构

将按钮改造成 3D 翻转结构：

```html
<button class="drawBack" style="transform-style: preserve-3d">
  <!-- 背面（初始可见）-->
  <div class="miniBack" style="backface-visibility: hidden; transform: rotateY(0deg)"></div>

  <!-- 正面（初始隐藏）-->
  <div class="faceCard" style="backface-visibility: hidden; transform: rotateY(180deg)">
    <img src="卡牌图片" />
  </div>
</button>
```

### 双面设置

```javascript
// 正面：rotateY(0deg) 时可见
frontFace.style.transform = "rotateY(0deg)";
frontFace.style.backfaceVisibility = "hidden";

// 背面：rotateY(180deg) 时可见
backFace.style.transform = "rotateY(180deg)";
backFace.style.backfaceVisibility = "hidden";
```

### 翻转动画

使用 Web Animations API：

```javascript
// 初始状态：显示背面
b.style.transform = "rotateY(180deg)";

// 翻转动画：180deg → 360deg (相当于 180deg → 0deg)
b.animate(
  [
    { transform: "rotateY(180deg)" },  // 起始：背面朝前
    { transform: "rotateY(360deg)" }   // 结束：正面朝前（360deg = 0deg）
  ],
  {
    duration: 360,  // 360ms
    easing: "cubic-bezier(0.4, 0, 0.2, 1)",  // ease-in-out
    fill: "forwards"  // 保持最终状态
  }
);
```

**效果**：
- 180° ~ 270°：背面逐渐消失（backface-visibility）
- 270° ~ 360°：正面逐渐显现
- 流畅的 3D 翻转效果

---

## 时间线

```
T+0ms     用户点击卡背
          ↓
T+0ms     创建双面结构
          🌲 ← 背面
          🎴 ← 正面（隐藏）
          ↓
T+0ms     开始翻转动画
          🌲 → 🎴 (360ms)
          ↓
T+180ms   翻转到 90°（侧面）
          | (看不见)
          ↓
T+360ms   翻转完成（正面）
          🎴
          ↓
T+360ms   关闭抽牌界面
          ↓
T+360ms   开始飞行动画
          🎴 → 玩家手牌
```

---

## 关键代码

### 位置
- **文件**：`src/ui.js`
- **函数**：`openDrawOverlay()` 内的点击处理
- **行数**：约 2824-2903

### 实现步骤

#### 1. 禁用按钮，设置 3D 变换

```javascript
b.disabled = true;  // 防止重复点击
b.style.transformStyle = "preserve-3d";
b.style.transition = "none";  // 清除 CSS 过渡
```

#### 2. 创建背面

```javascript
const backFace = document.createElement("div");
backFace.className = "miniBack";
backFace.style.width = "100%";
backFace.style.height = "100%";
backFace.style.position = "absolute";
backFace.style.backfaceVisibility = "hidden";
backFace.style.transform = "rotateY(0deg)";
```

#### 3. 创建正面

```javascript
const frontFace = document.createElement("div");
frontFace.className = `faceCard ${isJoker ? "joker imgCard" : "imgCard"}`;
frontFace.style.backfaceVisibility = "hidden";
frontFace.style.transform = "rotateY(180deg)";

if (isJoker) {
  frontFace.innerHTML = `<img src="./assets/joker.png" />`;
} else {
  frontFace.innerHTML = `<img src="${drawnCard.imgSrc}" />`;
}
```

#### 4. 重构按钮内容

```javascript
b.innerHTML = "";  // 清空原内容
b.appendChild(backFace);
b.appendChild(frontFace);
```

#### 5. 执行翻转动画

```javascript
const flipAnim = b.animate(
  [
    { transform: "rotateY(0deg)" },
    { transform: "rotateY(180deg)" }
  ],
  { duration: 360, easing: "cubic-bezier(0.4, 0, 0.2, 1)", fill: "forwards" }
);

flipAnim.onfinish = () => {
  closeDrawOverlay();  // 关闭界面
  animateDrawCardFly(...);  // 开始飞行
};
```

---

## 为什么不克隆

### 克隆的问题

如果使用克隆：
```javascript
const clone = b.cloneNode(true);  // ❌
clone.style.position = "fixed";
// 克隆元素飞走，原按钮仍在抽牌界面
```

**问题**：
- 原按钮仍在界面上，需要手动隐藏
- 克隆元素的事件监听器不会复制
- 管理两个元素（原按钮 + 克隆）复杂

### 原地修改的优势

```javascript
b.innerHTML = "";  // ✅ 直接修改
b.appendChild(backFace);
b.appendChild(frontFace);
b.animate(...);  // 原地翻转
```

**优势**：
- ✅ 只有一个元素，简单直接
- ✅ 翻转后自然过渡到飞行
- ✅ 关闭界面时自动清理（`drawRow.innerHTML = ""`）

---

## CSS 配合

需要确保 `.drawBack` 支持 3D 变换：

```css
.drawBack {
  /* 确保有固定的宽高 */
  width: 140px;
  height: 196px;

  /* 支持 3D 子元素 */
  transform-style: preserve-3d;

  /* 可选：添加透视效果 */
  perspective: 1000px;
}
```

当前 CSS（[styles.css:938-966](styles.css#L938-L966)）已经设置了基础样式，只需要通过 JS 动态添加 `transform-style`。

---

## 与其他动画的一致性

| 动画类型 | 翻转 | 飞行 | 时长 |
|---------|------|------|------|
| **抽牌（新）** | ✅ 原地翻转 360ms | → 手牌 | 360 + 飞行时长 |
| **AI抽JOKER** | ✅ 飞行中翻转 | → 中心 → 手牌 | ~2000ms |
| **AI抽普通牌** | ✅ 飞行中翻转 | → 手牌 | ~560ms |
| **AI出牌** | ✅ 飞行中翻转 | → 弃牌堆 | 680ms |

所有涉及从"背面"到"正面"的动画都包含翻转效果，保持一致！

---

## 视觉效果

### 修复前（直接飞行）

```
点击卡背
  ↓
🌲 (卡背)
 ↘️ (直接飞向手牌，看不到内容)
  ↘️
   🌲 (落地后才显示正面，有"跳变")
```

### 修复后（翻转 + 飞行）

```
点击卡背
  ↓
🌲 (卡背)
 ↻ (原地翻转 360ms)
  | (90° 侧面)
   ↻
    🎴 (正面显示，可以看到内容了)
     ↓
     ↘️ (飞向手牌)
      ↘️
       🎴 (落地)
```

---

## 用户体验提升

### 旧版问题
1. **不知道抽到什么**：卡背直接飞走，看不到内容
2. **突然跳变**：落地后才翻转，有"闪现"感
3. **缺乏反馈**：点击后没有视觉反馈

### 新版优势
1. **即时反馈**：点击后立即翻转，展示卡牌
2. **视觉连贯**：翻转 → 飞行 → 落地，一气呵成
3. **符合直觉**：像真实翻牌一样，先看到是什么，再加入手牌

---

## 性能

- **翻转动画**：纯 transform，GPU 加速
- **无克隆开销**：原地修改，节省内存
- **时长**：360ms，用户感知流畅
- **总体**：性能优秀，无卡顿

---

## 测试方法

1. 启动游戏：http://127.0.0.1:8000/english-old-maid/
2. 轮到你的回合
3. 点击上家手牌区域，打开抽牌界面
4. 点击任意卡背
5. 观察：
   - ✅ 卡牌原地翻转（360ms）
   - ✅ 翻转中显示卡牌图片
   - ✅ 翻转完成后关闭界面
   - ✅ 卡牌飞向你的手牌
   - ✅ 无克隆，无"跳变"

---

## 相关文件

- `src/ui.js` - 翻转动画实现
- `styles.css` - drawBack 样式
- `出牌动画统一方案.md` - 整体动画系统

---

**更新时间**：2026-01-11
**版本**：v4.2 - Draw Flip Animation
