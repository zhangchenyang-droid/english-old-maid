# 出牌"闪现"问题修复

## 问题描述

有时候玩家或 AI 出牌时，**看不到飞行动画**，弃牌堆会**突然闪现**出新的牌。

---

## 问题原因

### 玩家出牌流程（旧版）

```javascript
// 1. 立即执行出牌逻辑（加入 discardPile）
const res = window.Game.tryDiscardPairByCardIds(game, 0, a, b);

// 2. 启动飞行动画
if (res.ok) {
  flyToDiscard(aEl);  // 开始飞行
  flyToDiscard(bEl);
}

// 3. ❌ 立即更新 UI（包括弃牌堆）
renderAll(game, settings);  // 弃牌堆立即显示新卡
```

**时间线**：

```
T+0ms     点击"匹配出牌"
          tryDiscardPairByCardIds() 执行
          game.discardPile.push(card1, card2)
          ↓
T+0ms     flyToDiscard(aEl) 启动
          flyToDiscard(bEl) 启动
          卡牌开始飞行... 🎴↘️
          ↓
T+0ms     renderAll() 执行
          renderDiscardPile() 执行
          弃牌堆 DOM 立即显示 card1, card2 ❌
          ↓
T+520ms   飞行动画完成
          卡牌移除

结果：弃牌堆中已经显示了卡牌，飞行卡牌飞向"已有卡牌"的位置
      → 看起来像"重复"或"闪现"
```

### 核心问题

**在动画完成之前就更新了弃牌堆显示**，导致：
- 飞行的卡牌（z-index 100）
- 弃牌堆中已显示的卡牌（z-index 10/100）
- 两者重叠，或者飞行动画被弃牌堆卡牌遮挡

---

## 解决方案

### 新流程：动画优先

```javascript
// 1. 执行出牌逻辑
const res = window.Game.tryDiscardPairByCardIds(game, 0, a, b);

// 2. 启动飞行动画（带回调）
if (res.ok) {
  const animA = flyToDiscard(aEl);
  const animB = flyToDiscard(bEl);

  // 3. 等待动画完成后，再更新 UI
  animA.onfinish = () => {
    renderDiscardPile(game);  // ✅ 动画完成后才更新弃牌堆
    if (allAnimsDone) {
      renderSeats(game);
      renderAction(game);
    }
  };
}
```

**新时间线**：

```
T+0ms     点击"匹配出牌"
          tryDiscardPairByCardIds() 执行
          game.discardPile.push(card1, card2)
          ↓
T+0ms     flyToDiscard(aEl) 启动
          flyToDiscard(bEl) 启动
          卡牌开始飞行... 🎴↘️
          ↓
T+0ms     ⚠️ 不调用 renderAll()
          弃牌堆 DOM 保持原样（不显示新卡）
          ↓
T+520ms   飞行动画完成
          anim.onfinish 触发
          renderDiscardPile() 执行 ✅
          弃牌堆 DOM 显示新卡
          卡牌移除

结果：飞行卡牌 → 落地 → 弃牌堆更新
      → 流畅连贯，无重复，无闪现
```

---

## 代码修改

### 1. `flyToDiscard()` 函数

**位置**：`src/ui.js`，约 252-380 行

**改动**：

```diff
  fromEl.animate(keyframes, {
    duration: 520,
    easing: "linear"
- }).onfinish = () => fromEl.remove();
+ });
+
+ anim.onfinish = () => {
+   fromEl.remove();
+   // 动画完成后，更新弃牌堆显示
+   if (window.game) {
+     renderDiscardPile(window.game);
+   }
+ };
+
+ return anim; // 返回动画对象，方便外部监听
}
```

**关键**：
- 返回动画对象，方便外部追加回调
- 动画完成后自动调用 `renderDiscardPile`

---

### 2. 玩家出牌逻辑

**位置**：`src/ui.js`，约 3657-3709 行

**改动**：

```diff
  const res = window.Game.tryDiscardPairByCardIds(game, 0, a, b);
  if (res.ok) {
-   if (aEl) flyToDiscard(aEl);
-   if (bEl) flyToDiscard(bEl);
+   // 启动飞行动画，等动画完成后再更新UI
+   let animCompleted = 0;
+   const totalAnims = (aEl ? 1 : 0) + (bEl ? 1 : 0);
+
+   const onAnimComplete = () => {
+     animCompleted++;
+     if (animCompleted === totalAnims) {
+       // 所有动画完成后，更新手牌和其他UI
+       renderSeats(game);
+       renderAction(game, settings);
+       showLastEvent(game, settings);
+     }
+   };
+
+   if (aEl) {
+     const animA = flyToDiscard(aEl);
+     if (animA) {
+       const origFinish = animA.onfinish;
+       animA.onfinish = () => {
+         if (origFinish) origFinish();
+         onAnimComplete();
+       };
+     }
+   }
+
+   if (bEl) {
+     const animB = flyToDiscard(bEl);
+     if (animB) {
+       const origFinish = animB.onfinish;
+       animB.onfinish = () => {
+         if (origFinish) origFinish();
+         onAnimComplete();
+       };
+     }
+   }
+
    clearSelection();
  }
- renderAll(game, settings);
+ // ⚠️ 不要立即调用 renderAll，等动画完成后再更新
```

**关键**：
- 等待两张卡都飞行完成
- 每张卡完成时调用 `renderDiscardPile`（在 `flyToDiscard` 内部）
- 所有动画完成后，更新手牌和按钮状态

---

## AI 出牌逻辑

AI 出牌已经是正确的流程：

```javascript
animateAiDiscardPair(aiIdx, pair[0], pair[1], () => {
  // 动画完成的回调
  window.Game.tryDiscardPairByCardIds(game, aiIdx, ...);
  renderAll(game, settings);  // ✅ 动画完成后才更新
});
```

**无需修改**，AI 出牌逻辑本来就是先动画，再更新 UI。

---

## 初始配对动画

初始配对动画也已修复：

```javascript
anim.onfinish = () => {
  flyingCard.remove();
  renderDiscardPile(game);  // ✅ 每张卡落地后更新
  animCompleted++;
  // ...
};
```

**无需修改**，初始配对已在每张卡落地后更新弃牌堆。

---

## 效果对比

### 修复前（闪现）

```
用户视角：
1. 点击"匹配出牌"
2. 弃牌堆突然出现两张新卡 ❌ (闪现)
3. 看不到卡牌飞行过程
4. 手牌数量减少

问题：弃牌堆先更新，飞行卡牌被遮挡或重复显示
```

### 修复后（流畅）

```
用户视角：
1. 点击"匹配出牌"
2. 两张卡从手牌飞向弃牌堆 ✅ (流畅动画 520ms)
3. 卡牌落地后，弃牌堆显示新卡
4. 手牌数量减少

效果：先看到飞行，再看到落地，视觉连贯
```

---

## 关键原则

### 动画优先原则

```
逻辑执行（game.discardPile 更新）
  ↓
启动飞行动画
  ↓
⚠️ 不要更新 DOM（弃牌堆）
  ↓
等待动画完成
  ↓
✅ 动画完成后才更新 DOM
```

### 更新时机

| UI 元素 | 更新时机 |
|---------|---------|
| **game.discardPile（逻辑）** | 立即更新 |
| **飞行卡牌（动画）** | 立即启动 |
| **弃牌堆 DOM** | ⚠️ 动画完成后 |
| **手牌 DOM** | 动画完成后 |
| **按钮状态** | 动画完成后 |

---

## 为什么 AI 出牌没有这个问题

AI 出牌逻辑本来就是：

```javascript
// 1. 启动动画
animateAiDiscardPair(aiIdx, card1, card2, () => {
  // 2. 动画完成后，执行逻辑 + 更新 UI
  window.Game.tryDiscardPairByCardIds(...);
  renderAll(game, settings);
});
```

**顺序正确**：动画 → 逻辑 → UI 更新

而旧版玩家出牌是：

```javascript
// 1. 立即执行逻辑
window.Game.tryDiscardPairByCardIds(...);

// 2. 启动动画
flyToDiscard(aEl);

// 3. ❌ 立即更新 UI
renderAll(game, settings);
```

**顺序错误**：逻辑 → 动画 || UI 更新（并行）

---

## 测试方法

### 1. 玩家出牌测试

1. 开始游戏
2. 轮到你的回合，选择两张配对卡
3. 点击"匹配出牌"
4. 观察：
   - ✅ 看到两张卡飞向弃牌堆
   - ✅ 飞行过程流畅（520ms）
   - ✅ 落地后弃牌堆更新
   - ❌ 不应该看到"闪现"或重复卡牌

### 2. AI 出牌测试

1. 等待 AI 回合
2. AI 配对出牌
3. 观察：
   - ✅ 看到卡牌从 AI 手牌飞出
   - ✅ 翻转 + 抛物线轨迹（680ms）
   - ✅ 落地后弃牌堆更新
   - ❌ 不应该看到"闪现"

### 3. 初始配对测试

1. 开始游戏，观察发牌后
2. AI 自动配对出牌
3. 观察：
   - ✅ 看到卡牌从 AI 手牌飞出
   - ✅ 飞行动画（520ms）
   - ✅ 落地后弃牌堆更新
   - ❌ 不应该看到"闪现"

---

## 相关文件

- `src/ui.js` - `flyToDiscard()` 和玩家出牌逻辑
- `出牌动画统一方案.md` - 动画系统整体设计
- `AI配对出牌动画说明.md` - AI 动画详解

---

**更新时间**：2026-01-11
**版本**：v4.3 - Flash Fix for Discard Animation
