# AI 抽牌平衡机制

## 问题描述

之前 AI 抽牌是**完全随机**的，导致：
- AI 手牌 A/B 卡严重不平衡（例如 5 张 A 卡，1 张 B 卡）
- 很难配对，游戏体验差
- 玩家有平衡机制，但 AI 没有，不公平

---

## 解决方案：智能抽牌

### 新的 `getAiDrawIndex` 逻辑

AI 抽牌时会考虑：
1. **A/B 平衡** - 优先抽能平衡的牌
2. **配对可能** - 优先抽能配对的牌
3. **保留随机性** - 不是 100% 智能，有 30% 的随机性

---

## 实现原理

### 1️⃣ 统计 AI 手牌的 A/B 分布

```javascript
let aCount = 0, bCount = 0;
for (const c of ai.hand) {
  if (c.side === "A") aCount++;
  else if (c.side === "B") bCount++;
}
const diff = aCount - bCount;
```

**示例**：
```
AI 手牌：Bear_A, Cat_A, Dog_A, Sheep_A, Pig_B
A卡: 4张
B卡: 1张
差异: +3
```

### 2️⃣ 确定需要的卡牌类型

```javascript
const needSide = diff > 1 ? "B" : (diff < -1 ? "A" : null);
```

**规则**：
- 差异 > +1：需要 B 卡（A 卡太多）
- 差异 < -1：需要 A 卡（B 卡太多）
- 差异在 [-1, 1]：均衡，无特殊需求

**示例**：
```
差异 = +3 → 需要 B 卡
```

### 3️⃣ 给上家手牌的每张牌打分

```javascript
for (let i = 0; i < target.hand.length; i++) {
  let priority = 1; // 基础优先级

  // 能配对：+5
  if (能与AI手牌配对) priority += 5;

  // 能平衡：+10
  if (c.side === needSide) priority += 10;

  candidates.push({ index: i, priority });
}
```

**优先级表**：
| 牌的特征 | 优先级 |
|---------|--------|
| 普通牌 | 1 |
| 能配对 | 6 (1+5) |
| 能平衡 | 11 (1+10) |
| 能配对+能平衡 | 16 (1+5+10) |

**示例**（AI 需要 B 卡）：
```
上家手牌（玩家）：
- Bear_A: 优先级 1（普通）
- Cat_B: 优先级 11（能平衡，但不能配对）
- Dog_B: 优先级 16（能平衡 + 能配对！）
- Sheep_A: 优先级 6（能配对，但会加剧不平衡）
```

### 4️⃣ 选择前 30% 高优先级的牌

```javascript
candidates.sort((a, b) => b.priority - a.priority);
const topN = Math.max(1, Math.ceil(candidates.length * 0.3));
const topCandidates = candidates.slice(0, topN);
```

**示例**：
```
排序后：
1. Dog_B (16)   ← 前30%
2. Cat_B (11)   ← 前30%
3. Sheep_A (6)
4. Bear_A (1)
```

### 5️⃣ 从前 30% 中随机选一张

```javascript
const chosen = topCandidates[Math.floor(Math.random() * topCandidates.length)];
return chosen.index;
```

**效果**：
- **70% 智能**：从高优先级牌中选择
- **30% 随机**：保留游戏的不可预测性
- **公平性**：AI 和玩家都有平衡机制

---

## 对比：旧版 vs 新版

### 旧版（完全随机）

```javascript
// AI 抽牌
return Math.floor(Math.random() * target.hand.length);

// 结果：
// - 20% 概率抽到 Dog_B（能平衡+能配对）
// - 20% 概率抽到 Cat_B（能平衡）
// - 20% 概率抽到 Sheep_A（能配对，但不平衡）
// - 20% 概率抽到 Bear_A（普通）
// - 20% 概率抽到 Fox_A（普通）

// 平均优先级：(16+11+6+1+1)/5 = 7
```

### 新版（智能选择）

```javascript
// AI 抽牌（考虑平衡）
// 前30%: Dog_B(16), Cat_B(11)
// 随机选择：50% Dog_B, 50% Cat_B

// 结果：
// - 50% 概率抽到 Dog_B（能平衡+能配对）✅
// - 50% 概率抽到 Cat_B（能平衡）✅
// - 0% 概率抽到普通牌

// 平均优先级：(16+11)/2 = 13.5 ⬆️ 提升 93%
```

---

## 平衡阈值：差异 > 1

**为什么选择差异 > 1？**

| 差异 | 含义 | 是否触发平衡 |
|------|------|-------------|
| 0 | A:3, B:3（完美均衡）| ❌ 不需要 |
| +1 | A:4, B:3（轻微偏 A）| ❌ 可接受 |
| +2 | A:5, B:3（明显偏 A）| ✅ 需要 B 卡 |
| +3 | A:6, B:3（严重偏 A）| ✅ 需要 B 卡 |
| -2 | A:3, B:5（明显偏 B）| ✅ 需要 A 卡 |

**设计理由**：
- 差异 ≤ 1：自然波动，不需要干预
- 差异 > 1：影响游戏体验，需要平衡

---

## 日志示例

### AI 抽牌时的控制台输出

```
[AI抽牌] AI1 手牌 A:5 B:2 差异:3 需要:B
[AI抽牌] 候选牌:8 前30%:3 选中优先级:16
→ AI1 抽到 Dog_B（既能平衡，又能配对）

[AI抽牌] AI2 手牌 A:3 B:3 差异:0 需要:均衡
[AI抽牌] 候选牌:7 前30%:3 选中优先级:6
→ AI2 抽到 Cat_A（能配对，但不需要平衡）

[AI抽牌] AI3 手牌 A:1 B:4 差异:-3 需要:A
[AI抽牌] 候选牌:5 前30%:2 选中优先级:11
→ AI3 抽到 Bear_A（能平衡）
```

---

## 与玩家平衡机制的对比

### 玩家抽牌（实时替换）

**位置**：`src/ui.js` 第 2728-2818 行

**机制**：
- 点击卡背 → 先抽牌 → **如果不匹配**，实时替换成能匹配的牌
- 替换概率：60% - 85%（根据连续未匹配次数）
- 优先选择能平衡 A/B 的牌

**特点**：
- 🎁 **偏向玩家**：直接替换成能匹配的牌
- ⚡ **实时生效**：抽牌瞬间替换
- 📊 **渐进概率**：连续不匹配后概率提升

### AI 抽牌（智能选择）

**位置**：`src/game.js` 第 917-964 行

**机制**：
- 抽牌前 → 评估所有候选牌 → 从前 30% 高优先级牌中随机选择
- 优先级：能平衡（+10）> 能配对（+5）> 普通（1）
- 不保证能配对，只是**提高概率**

**特点**：
- ⚖️ **公平竞争**：不直接替换，只是提高抽到好牌的概率
- 🎲 **保留随机性**：前 30% 中随机，仍有运气成分
- 🧠 **智能平衡**：优先考虑 A/B 平衡

---

## 游戏难度平衡

### 旧版（AI 完全随机）

```
玩家：有实时替换（60-85%） ✅
AI：完全随机 ❌

结果：玩家优势过大，游戏太简单
```

### 新版（AI 智能抽牌）

```
玩家：有实时替换（60-85%） ✅
AI：智能选择（前30%） ✅

结果：双方都有策略，游戏更有挑战性
```

---

## 测试方法

### 1. 观察 AI 抽牌

1. 开始游戏
2. 轮到 AI 回合
3. 打开控制台，观察日志：
   ```
   [AI抽牌] AI1 手牌 A:5 B:2 差异:3 需要:B
   [AI抽牌] 候选牌:8 前30%:3 选中优先级:16
   ```

4. 多玩几轮，观察 AI 手牌的 A/B 分布

### 2. 对比玩家抽牌

1. 轮到你的回合
2. 打开抽牌界面
3. 点击卡背，观察控制台：
   ```
   [平衡] 玩家手牌 A:4 B:1 差异:3 需要:B
   [实时替换] 换入 B 侧牌（优先级:10）
   ```

4. 对比 AI 和玩家的平衡效果

### 3. 极端情况测试

1. 等待 AI 手牌严重不平衡（例如 A:7, B:1）
2. 观察 AI 抽牌时是否优先抽 B 卡
3. 检查几轮后 A/B 是否逐渐平衡

---

## 预期效果

### AI 手牌 A/B 分布

玩 10 轮后，AI 手牌的 A/B 差异应该：
- **旧版**：差异可能达到 ±5 或更高（严重不平衡）
- **新版**：差异通常在 ±2 以内（相对均衡）

### 游戏体验

- ✅ AI 更容易配对（不会因为不平衡而卡手）
- ✅ 游戏节奏更快（AI 不会长期无法出牌）
- ✅ 玩家和 AI 都有策略性
- ✅ 保留随机性，不会太机械

---

## 相关文件

- `src/game.js` - `getAiDrawIndex()` 函数
- `src/ui.js` - 玩家实时替换逻辑（第 2728-2818 行）
- `出牌动画统一方案.md` - 动画系统

---

**更新时间**：2026-01-11
**版本**：v5.0 - AI Smart Draw with A/B Balance
