<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å…³é”®å¸§ç¼–è¾‘å™¨ - æŠ½å¡åŠ¨ç”»</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      overflow: hidden;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #16213e;
      padding: 16px 24px;
      border-bottom: 2px solid #4ecca3;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 20px;
      color: #4ecca3;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    button {
      padding: 10px 20px;
      background: #4ecca3;
      color: #1a1a2e;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: #5ef5b3;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: rgba(255,255,255,0.1);
      color: #eee;
    }

    button.danger {
      background: #e74c3c;
      color: white;
    }

    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .preview {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0f3460;
      position: relative;
    }

    .stage {
      width: 800px;
      height: 400px;
      background: linear-gradient(135deg, #2d5016 0%, #1a3a0f 100%);
      border-radius: 20px;
      position: relative;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .card {
      width: 52px;
      height: 72px;
      background: url('./assets/card-back.png') center/cover;
      border-radius: 8px;
      border: 2px solid #4ecca3;
      position: absolute;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: move;
      transition: box-shadow 0.2s;
    }

    .card.animating {
      border-color: #e74c3c;
      box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(78, 204, 163, 0.5);
    }

    .timeline-panel {
      width: 400px;
      background: #16213e;
      border-left: 2px solid #4ecca3;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .timeline-header {
      padding: 16px;
      background: #0f1b2e;
      border-bottom: 1px solid rgba(78, 204, 163, 0.3);
    }

    .timeline-header h2 {
      font-size: 16px;
      color: #93deff;
      margin-bottom: 12px;
    }

    .playhead-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .playhead-time {
      font-size: 24px;
      font-weight: 700;
      color: #4ecca3;
      font-variant-numeric: tabular-nums;
      min-width: 100px;
    }

    .timeline-scrubber {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }

    .scrubber-fill {
      height: 100%;
      background: #4ecca3;
      border-radius: 3px;
      position: relative;
    }

    .scrubber-handle {
      width: 16px;
      height: 16px;
      background: #4ecca3;
      border-radius: 50%;
      position: absolute;
      right: -8px;
      top: -5px;
      cursor: grab;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .scrubber-handle:active {
      cursor: grabbing;
    }

    .keyframes-list {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .keyframe {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(78, 204, 163, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .keyframe:hover {
      background: rgba(78, 204, 163, 0.1);
      border-color: #4ecca3;
    }

    .keyframe.active {
      background: rgba(78, 204, 163, 0.2);
      border-color: #4ecca3;
      box-shadow: 0 0 20px rgba(78, 204, 163, 0.3);
    }

    .keyframe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .keyframe-time {
      font-size: 18px;
      font-weight: 700;
      color: #4ecca3;
    }

    .keyframe-delete {
      padding: 4px 12px;
      font-size: 12px;
    }

    .keyframe-props {
      display: grid;
      gap: 8px;
    }

    .prop-row {
      display: grid;
      grid-template-columns: 60px 1fr 80px;
      gap: 8px;
      align-items: center;
    }

    .prop-label {
      font-size: 12px;
      color: #93deff;
    }

    .prop-value {
      font-size: 12px;
      color: #4ecca3;
      font-variant-numeric: tabular-nums;
    }

    input[type="range"] {
      width: 100%;
      height: 4px;
      background: rgba(255,255,255,0.1);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #4ecca3;
      cursor: pointer;
    }

    input[type="number"] {
      width: 100%;
      padding: 4px 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      color: #eee;
      font-size: 12px;
    }

    .add-keyframe-btn {
      margin: 16px;
      width: calc(100% - 32px);
    }

    .playback-controls {
      display: flex;
      gap: 8px;
    }

    .play-btn {
      padding: 8px 16px;
      font-size: 20px;
      min-width: 60px;
    }

    .help {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(0,0,0,0.8);
      padding: 16px;
      border-radius: 8px;
      font-size: 12px;
      color: #93deff;
      max-width: 250px;
    }

    .help h3 {
      color: #4ecca3;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .help ul {
      list-style: none;
      padding: 0;
    }

    .help li {
      margin: 4px 0;
      padding-left: 16px;
      position: relative;
    }

    .help li:before {
      content: "â–¸";
      position: absolute;
      left: 0;
      color: #4ecca3;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>ğŸ¬ å…³é”®å¸§ç¼–è¾‘å™¨</h1>
      <div class="header-actions">
        <button id="exportBtn" class="secondary">å¯¼å‡ºå‚æ•°</button>
        <button id="resetBtn" class="danger">é‡ç½®</button>
      </div>
    </div>

    <div class="main">
      <div class="preview">
        <div class="stage" id="stage">
          <div class="card" id="card" style="left: 100px; top: 100px;"></div>
        </div>

        <div class="help">
          <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
          <ul>
            <li>æ‹–åŠ¨æ—¶é—´è½´æŸ¥çœ‹åŠ¨ç”»</li>
            <li>ç‚¹å‡»"æ·»åŠ å…³é”®å¸§"</li>
            <li>æ‹–åŠ¨å¡ç‰Œåˆ°ç›®æ ‡ä½ç½®</li>
            <li>è°ƒæ•´ç¼©æ”¾/æ—‹è½¬å‚æ•°</li>
            <li>ç‚¹å‡»æ’­æ”¾é¢„è§ˆåŠ¨ç”»</li>
            <li>æ»¡æ„åç‚¹å‡»"å¯¼å‡ºå‚æ•°"</li>
          </ul>
        </div>
      </div>

      <div class="timeline-panel">
        <div class="timeline-header">
          <h2>æ—¶é—´è½´æ§åˆ¶</h2>

          <div class="playhead-controls">
            <div class="playback-controls">
              <button class="play-btn" id="playBtn">â–¶</button>
              <button class="secondary" id="stopBtn">â– </button>
            </div>
            <div class="playhead-time" id="playheadTime">0ms</div>
          </div>

          <div class="timeline-scrubber" id="scrubber">
            <div class="scrubber-fill" id="scrubberFill" style="width: 0%;">
              <div class="scrubber-handle" id="scrubberHandle"></div>
            </div>
          </div>
        </div>

        <div class="keyframes-list" id="keyframesList">
          <!-- å…³é”®å¸§åˆ—è¡¨ -->
        </div>

        <button class="add-keyframe-btn" id="addKeyframeBtn">+ æ·»åŠ å…³é”®å¸§</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      currentTime: 0,
      duration: 500,
      isPlaying: false,
      activeKeyframeIndex: null,
      keyframes: [
        { time: 0, x: 100, y: 100, scale: 1, rotation: 0 }
      ]
    };

    const card = document.getElementById('card');
    const stage = document.getElementById('stage');
    const playheadTime = document.getElementById('playheadTime');
    const scrubber = document.getElementById('scrubber');
    const scrubberFill = document.getElementById('scrubberFill');
    const scrubberHandle = document.getElementById('scrubberHandle');
    const keyframesList = document.getElementById('keyframesList');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const addKeyframeBtn = document.getElementById('addKeyframeBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');

    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    function updateTime(time) {
      state.currentTime = Math.max(0, Math.min(state.duration, time));
      playheadTime.textContent = Math.round(state.currentTime) + 'ms';
      scrubberFill.style.width = (state.currentTime / state.duration * 100) + '%';

      // æ’å€¼è®¡ç®—å½“å‰çŠ¶æ€
      updateCardFromTime(state.currentTime);
    }

    // æ ¹æ®æ—¶é—´æ’å€¼è®¡ç®—å¡ç‰ŒçŠ¶æ€
    function updateCardFromTime(time) {
      const sorted = [...state.keyframes].sort((a, b) => a.time - b.time);

      let before = sorted[0];
      let after = sorted[sorted.length - 1];

      for (let i = 0; i < sorted.length - 1; i++) {
        if (time >= sorted[i].time && time <= sorted[i + 1].time) {
          before = sorted[i];
          after = sorted[i + 1];
          break;
        }
      }

      if (before.time === after.time) {
        setCardTransform(before);
        return;
      }

      const t = (time - before.time) / (after.time - before.time);
      const eased = easeInOutCubic(t);

      const interpolated = {
        x: lerp(before.x, after.x, eased),
        y: lerp(before.y, after.y, eased),
        scale: lerp(before.scale, after.scale, eased),
        rotation: lerp(before.rotation, after.rotation, eased)
      };

      setCardTransform(interpolated);
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function easeInOutCubic(t) {
      return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    function setCardTransform(props) {
      card.style.left = props.x + 'px';
      card.style.top = props.y + 'px';
      card.style.transform = `scale(${props.scale}) rotate(${props.rotation}deg)`;
    }

    // æ‹–åŠ¨æ—¶é—´è½´
    let isDraggingScrubber = false;

    scrubber.addEventListener('mousedown', (e) => {
      isDraggingScrubber = true;
      updateTimeFromMouse(e);
    });

    document.addEventListener('mousemove', (e) => {
      if (isDraggingScrubber) {
        updateTimeFromMouse(e);
      }
    });

    document.addEventListener('mouseup', () => {
      isDraggingScrubber = false;
    });

    function updateTimeFromMouse(e) {
      const rect = scrubber.getBoundingClientRect();
      const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
      const time = (x / rect.width) * state.duration;
      updateTime(time);
    }

    // æ‹–åŠ¨å¡ç‰Œ
    let isDraggingCard = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    card.addEventListener('mousedown', (e) => {
      isDraggingCard = true;
      const rect = card.getBoundingClientRect();
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;
      card.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e) => {
      if (isDraggingCard) {
        const stageRect = stage.getBoundingClientRect();
        const x = e.clientX - stageRect.left - dragOffsetX;
        const y = e.clientY - stageRect.top - dragOffsetY;

        card.style.left = x + 'px';
        card.style.top = y + 'px';

        // æ›´æ–°å½“å‰å…³é”®å¸§
        if (state.activeKeyframeIndex !== null) {
          state.keyframes[state.activeKeyframeIndex].x = x;
          state.keyframes[state.activeKeyframeIndex].y = y;
          renderKeyframes();
        }
      }
    });

    document.addEventListener('mouseup', () => {
      if (isDraggingCard) {
        isDraggingCard = false;
        card.style.cursor = 'move';
      }
    });

    // æ¸²æŸ“å…³é”®å¸§åˆ—è¡¨
    function renderKeyframes() {
      keyframesList.innerHTML = '';
      state.keyframes.sort((a, b) => a.time - b.time).forEach((kf, index) => {
        const div = document.createElement('div');
        div.className = 'keyframe';
        if (index === state.activeKeyframeIndex) {
          div.classList.add('active');
        }

        div.innerHTML = `
          <div class="keyframe-header">
            <div class="keyframe-time">${kf.time}ms</div>
            <button class="keyframe-delete danger" onclick="deleteKeyframe(${index})">åˆ é™¤</button>
          </div>
          <div class="keyframe-props">
            <div class="prop-row">
              <span class="prop-label">X</span>
              <input type="range" min="0" max="800" value="${kf.x}"
                onchange="updateKeyframeProp(${index}, 'x', this.value)">
              <span class="prop-value">${Math.round(kf.x)}</span>
            </div>
            <div class="prop-row">
              <span class="prop-label">Y</span>
              <input type="range" min="0" max="400" value="${kf.y}"
                onchange="updateKeyframeProp(${index}, 'y', this.value)">
              <span class="prop-value">${Math.round(kf.y)}</span>
            </div>
            <div class="prop-row">
              <span class="prop-label">ç¼©æ”¾</span>
              <input type="range" min="0.1" max="5" step="0.1" value="${kf.scale}"
                onchange="updateKeyframeProp(${index}, 'scale', this.value)">
              <span class="prop-value">${kf.scale.toFixed(1)}</span>
            </div>
            <div class="prop-row">
              <span class="prop-label">æ—‹è½¬</span>
              <input type="range" min="-180" max="180" value="${kf.rotation}"
                onchange="updateKeyframeProp(${index}, 'rotation', this.value)">
              <span class="prop-value">${Math.round(kf.rotation)}Â°</span>
            </div>
            <div class="prop-row">
              <span class="prop-label">æ—¶é—´</span>
              <input type="number" min="0" max="${state.duration}" value="${kf.time}"
                onchange="updateKeyframeProp(${index}, 'time', this.value)">
              <span class="prop-value">ms</span>
            </div>
          </div>
        `;

        div.addEventListener('click', () => {
          state.activeKeyframeIndex = index;
          updateTime(kf.time);
          renderKeyframes();
        });

        keyframesList.appendChild(div);
      });
    }

    window.updateKeyframeProp = function(index, prop, value) {
      state.keyframes[index][prop] = parseFloat(value);
      updateCardFromTime(state.currentTime);
      renderKeyframes();
    };

    window.deleteKeyframe = function(index) {
      if (state.keyframes.length <= 1) {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªå…³é”®å¸§ï¼');
        return;
      }
      state.keyframes.splice(index, 1);
      state.activeKeyframeIndex = null;
      renderKeyframes();
      updateCardFromTime(state.currentTime);
    };

    // æ·»åŠ å…³é”®å¸§
    addKeyframeBtn.addEventListener('click', () => {
      const rect = card.getBoundingClientRect();
      const stageRect = stage.getBoundingClientRect();

      const newKf = {
        time: state.currentTime,
        x: rect.left - stageRect.left,
        y: rect.top - stageRect.top,
        scale: 1,
        rotation: 0
      };

      state.keyframes.push(newKf);
      state.activeKeyframeIndex = state.keyframes.length - 1;
      renderKeyframes();
    });

    // æ’­æ”¾åŠ¨ç”»
    let playInterval = null;

    playBtn.addEventListener('click', () => {
      if (state.isPlaying) {
        stopAnimation();
      } else {
        startAnimation();
      }
    });

    stopBtn.addEventListener('click', () => {
      stopAnimation();
      updateTime(0);
    });

    function startAnimation() {
      state.isPlaying = true;
      playBtn.textContent = 'âšâš';
      card.classList.add('animating');

      const startTime = Date.now() - state.currentTime;

      playInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;

        if (elapsed >= state.duration) {
          stopAnimation();
          updateTime(state.duration);
        } else {
          updateTime(elapsed);
        }
      }, 16);
    }

    function stopAnimation() {
      state.isPlaying = false;
      playBtn.textContent = 'â–¶';
      card.classList.remove('animating');
      if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
      }
    }

    // å¯¼å‡ºå‚æ•°
    exportBtn.addEventListener('click', () => {
      const sorted = [...state.keyframes].sort((a, b) => a.time - b.time);
      const output = {
        duration: state.duration,
        keyframes: sorted
      };

      const json = JSON.stringify(output, null, 2);

      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'animation-keyframes.json';
      a.click();
      URL.revokeObjectURL(url);

      alert('å‚æ•°å·²å¯¼å‡ºï¼\n\nä½ ä¹Ÿå¯ä»¥å¤åˆ¶æ§åˆ¶å°ä¸­çš„å‚æ•°ä»£ç ã€‚');
      console.log('=== åŠ¨ç”»å‚æ•° ===');
      console.log(json);
      console.log('\n=== ç”¨äºä»£ç çš„æ ¼å¼ ===');
      sorted.forEach((kf, i) => {
        console.log(`// å…³é”®å¸§ ${i + 1} - ${kf.time}ms`);
        console.log(`{ x: ${Math.round(kf.x)}, y: ${Math.round(kf.y)}, scale: ${kf.scale.toFixed(2)}, rotation: ${Math.round(kf.rotation)} }`);
      });
    });

    // é‡ç½®
    resetBtn.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å…³é”®å¸§å—ï¼Ÿ')) {
        state.keyframes = [
          { time: 0, x: 100, y: 100, scale: 1, rotation: 0 }
        ];
        state.activeKeyframeIndex = 0;
        state.currentTime = 0;
        renderKeyframes();
        updateTime(0);
      }
    });

    // åˆå§‹åŒ–
    renderKeyframes();
    updateTime(0);
  </script>
</body>
</html>
