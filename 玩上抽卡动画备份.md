# 玩上抽卡动画备份

**备份时间**：2026-01-13
**版本**：三阶段甩卡动画 + 动态速度调整

---

## 1. 玩上手牌三阶段甩卡动画

### 代码位置
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**函数**：`animateUpstreamRotateAndOpen(fromIdx)`
**行号**：约3058-3233行

### 完整代码

```javascript
// 上家手牌动画
function animateUpstreamRotateAndOpen(fromIdx) {
  const upstream = game.players[fromIdx];
  if (!upstream || upstream.hand.length === 0) {
    openDrawOverlay(fromIdx);
    return;
  }

  const handEl = seatHandElByPlayerIndex(fromIdx);
  const backs = Array.from(handEl.querySelectorAll(".miniBack"));
  if (backs.length === 0) {
    openDrawOverlay(fromIdx);
    return;
  }

  // 边界情况：只有1张牌，直接打开抽牌界面
  if (backs.length === 1) {
    openDrawOverlay(fromIdx);
    return;
  }

  // 获取目标位置（第一张牌的位置）
  const bottomCard = backs[0];
  const targetSx = bottomCard.style.getPropertyValue('--sx') || '0px';
  const targetSy = bottomCard.style.getPropertyValue('--sy') || '0px';
  const targetSrot = bottomCard.style.getPropertyValue('--srot') || '0deg';

  // 解析目标旋转角度数值
  const targetRotValue = parseFloat(targetSrot);

  // 立即显示背景变暗+模糊
  const drawOverlay = document.getElementById("drawOverlay");
  if (drawOverlay) {
    drawOverlay.classList.remove("hidden");
    // 参考抽卡界面默认背景（65%不透明度）+ 模糊
    drawOverlay.style.background = "rgba(0,0,0,0.65)";
    drawOverlay.style.backdropFilter = "blur(6px)";
    drawOverlay.style.transition = "opacity 300ms ease-out, backdrop-filter 300ms ease-out";
    drawOverlay.style.opacity = "0";

    // 触发渐显
    requestAnimationFrame(() => {
      drawOverlay.style.opacity = "1";
    });
  }

  // 第一阶段：合拢+开始向左蓄力（100ms，ease-in缓动）
  backs.forEach(card => {
    card.style.transition = 'left 100ms ease-in, top 100ms ease-in, transform 100ms ease-in';
  });

  requestAnimationFrame(() => {
    // 解析目标位置的数值
    const targetSxValue = parseFloat(targetSx);
    const targetSyValue = parseFloat(targetSy);

    backs.forEach(card => {
      // 合拢到第一张牌位置，同时向左移动30px（蓄力弧线起点）
      card.style.setProperty('--sx', `${targetSxValue - 30}px`);
      card.style.setProperty('--sy', `${targetSyValue}px`);
      // 在目标角度基础上减30度（逆时针旋转）
      card.style.setProperty('--srot', `${targetRotValue - 30}deg`);
    });
  });

  // 100ms后（第二阶段开始时）：开始甩卡动画
  setTimeout(() => {
    // 先调用 openDrawOverlay 创建抽牌卡片（以便获取抽1的位置）
    openDrawOverlay(fromIdx);

    // 立即隐藏抽牌界面内容（等第三阶段结束后再显示）
    const drawOverlayInner = document.querySelector(".drawOverlayInner");
    if (drawOverlayInner) {
      drawOverlayInner.style.opacity = "0";
      drawOverlayInner.style.transition = "none";
    }

    // 等待DOM更新后获取抽1位置
    requestAnimationFrame(() => {
      const drawRow = document.getElementById("drawRow");
      const firstDrawCard = drawRow ? drawRow.querySelector(".drawBack") : null;

      if (firstDrawCard) {
        const drawCardRect = firstDrawCard.getBoundingClientRect();
        const endX = drawCardRect.left + drawCardRect.width / 2;
        const endY = drawCardRect.top + drawCardRect.height / 2;

        // 第二阶段：继续向左蓄力到100px（ease-out减速，形成弧线顶点）
        backs.forEach(card => {
          // 使用 ease-out：快开始，慢结束（蓄力弧线的减速段）
          card.style.transition = 'left 180ms ease-out, top 180ms ease-out, transform 180ms ease-out';

          // 从第一阶段的-30px继续向左到-100px（总共70px）
          const targetSxValue = parseFloat(targetSx);
          card.style.setProperty('--sx', `${targetSxValue - 100}px`);

          // 继续旋转（逆时针100度）
          const currentSrot = parseFloat(card.style.getPropertyValue('--srot') || '0');
          card.style.setProperty('--srot', `${currentSrot - 100}deg`);
        });

        // 180ms后第三阶段：甩回抽1中心
        setTimeout(() => {
          // 实时获取抽1的最新位置
          const firstDrawCardNow = drawRow ? drawRow.querySelector(".drawBack") : firstDrawCard;
          if (!firstDrawCardNow) {
            // 如果抽1不存在，直接显示界面
            const drawOverlayInner = document.querySelector(".drawOverlayInner");
            if (drawOverlayInner) drawOverlayInner.style.opacity = "1";
            return;
          }

          const drawCardRectNow = firstDrawCardNow.getBoundingClientRect();
          const endXNow = drawCardRectNow.left + drawCardRectNow.width / 2;
          const endYNow = drawCardRectNow.top + drawCardRectNow.height / 2;

          // 计算从当前位置到抽1的距离
          const currentRect = bottomCard.getBoundingClientRect();
          const deltaX = endXNow - (currentRect.left + currentRect.width / 2);
          const deltaY = endYNow - (currentRect.top + currentRect.height / 2);
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

          // 根据距离动态调整时长（距离越远，时间越长）
          // 基础时长120ms，每100px增加30ms
          const baseDuration = 120;
          const durationPerDist = 0.3; // 每px增加0.3ms
          const duration = Math.min(300, Math.max(80, baseDuration + distance * durationPerDist));

          backs.forEach(card => {
            // 第三阶段：甩出动作，使用 ease-out（快开始，缓慢结束）
            card.style.transition = `left ${duration}ms ease-out, top ${duration}ms ease-out, transform ${duration}ms ease-out`;
            const currentSx = parseFloat(card.style.getPropertyValue('--sx') || '0');
            const currentSy = parseFloat(card.style.getPropertyValue('--sy') || '0');
            card.style.setProperty('--sx', `${currentSx + deltaX}px`);
            card.style.setProperty('--sy', `${currentSy + deltaY}px`);
            // 继续逆时针旋转90度
            const currentSrot = parseFloat(card.style.getPropertyValue('--srot') || '0');
            card.style.setProperty('--srot', `${currentSrot - 90}deg`);
          });

          // 立即隐藏上家手牌（第三阶段开始时就隐藏）
          backs.forEach(card => {
            // 添加opacity过渡
            card.style.transition = `left ${duration}ms ease-out, top ${duration}ms ease-out, transform ${duration}ms ease-out, opacity 60ms ease-out`;
          });

          // 10ms后开始淡出
          setTimeout(() => {
            backs.forEach(card => {
              card.style.opacity = '0';
            });
          }, 10);

          // 第三阶段结束前显示抽牌界面（动态时长）
          setTimeout(() => {
            const drawOverlayInner = document.querySelector(".drawOverlayInner");
            if (drawOverlayInner) {
              drawOverlayInner.style.transition = 'opacity 60ms ease-out';
              drawOverlayInner.style.opacity = '1';
            }
          }, duration); // 使用动态计算的时长

          // 动画结束后清理transition
          setTimeout(() => {
            backs.forEach(card => {
              card.style.transition = '';
            });
          }, duration);
        }, 180);
      } else {
        // 如果没找到抽1，直接显示抽牌界面
        backs.forEach(card => {
          card.style.transition = '';
        });
      }
    });
  }, 100);
}
```

### 动画参数总结

| 阶段 | 时长 | 缓动 | 位移 | 旋转 |
|------|------|------|------|------|
| **第一阶段** | 100ms | ease-in | 向左30px | 逆时针30° |
| **第二阶段** | 180ms | ease-out | 继续向左到100px | 逆时针100° |
| **第三阶段** | 动态80-300ms | ease-out | 甩回抽1中心 | 逆时针90° |
| **背景渐显** | 300ms | ease-out | - | - |

**总旋转量**：逆时针220度（约0.6圈）

**动态速度公式**：
```javascript
duration = 120ms + (distance × 0.3ms)
范围：80ms ~ 300ms
```

---

## 2. 抽卡界面卡组展开动画

### CSS 代码位置
**文件**：`/Users/karnoz/english-old-maid/styles.css`
**类名**：`.drawBack`
**行号**：约949-966行

### 完整代码

```css
.drawBack {
  width: 140px;
  height: 196px;
  border-radius: 20px;
  background-image: url("./assets/card-back.png");
  background-size: cover;
  background-position: center;
  border: 1px solid rgba(255,255,255,0.22);
  cursor: pointer;
  user-select: none;
  flex: 0 0 auto;
  scroll-snap-align: none;
  /* 初始状态：所有卡片从抽1位置（第一张卡位置）开始 */
  transform: translateY(0px) translateX(var(--preX, 0px));
  opacity: 0;
  transition: transform 420ms cubic-bezier(0.22, 1, 0.36, 1), opacity 260ms ease;
  isolation: isolate;
  will-change: transform, opacity;
}
```

### JavaScript 设置
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**位置**：约3286行

```javascript
// "码开" feel: start overlapped then spread to normal positions.
b.style.setProperty("--preX", `${-i * 26}px`);
```

### 动画效果

**初始状态**：
- 所有卡片叠在抽1位置（第一张）
- `--preX` 设置为负值，让它们水平重叠
- `opacity: 0`（透明）

**展开动画**：
- 420ms：从重叠位置展开到各自位置（`translateX(0)`）
- 260ms：淡入显示（`opacity: 1`）
- 缓动：`cubic-bezier(0.22, 1, 0.36, 1)`（平滑弹性）

**视觉效果**：
卡片从抽1位置"炸开"，像扇子一样展开

---

## 3. 点击事件绑定

### 代码位置
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约4376-4387行

```javascript
document.addEventListener("click", (e) => {
  const b = e.target.closest(".seatHand[data-from-player-index]");
  if (!b) return;
  if (!game || game.gameOver) return;
  const current = game.players[game.currentPlayerIndex];
  if (current.kind !== "human") return;
  const fromIdx = Number(b.dataset.fromPlayerIndex);
  markHumanAction();

  // 触发甩卡动画
  animateUpstreamRotateAndOpen(fromIdx);
});
```

---

## 4. 关闭抽卡界面后的处理

### 代码位置
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**函数**：`closeDrawOverlay()`
**行号**：约3603-3606行

```javascript
// 直接重新渲染玩上手牌，无展开动画
if (game && !game.gameOver) {
  renderSeats(game);
}
```

**效果**：关闭抽卡界面后，玩上手牌直接显示为展开状态，无动画。

---

## 5. 提示动画保护机制

### 代码位置1：clearHintHighlight()
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约2503-2515行

```javascript
function clearHintHighlight() {
  const cards = Array.from($("#pBottomHand").querySelectorAll(".faceCard"));
  for (const el of cards) {
    el.classList.remove("hintPulse");
    el.classList.remove("hintPulseAuto");
  }

  // 清除保护标记，允许 renderSeats 重建元素
  const bottomHandEl = document.getElementById("pBottomHand");
  if (bottomHandEl) {
    bottomHandEl.dataset.adjusting = "";
  }
}
```

### 代码位置2：maybeShowHint()
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约2528-2558行

```javascript
// 设置保护标记，防止 renderSeats 打断提示动画
const bottomHandEl = document.getElementById("pBottomHand");
if (bottomHandEl) {
  bottomHandEl.dataset.adjusting = "true";
}

// ... 添加 hintPulse 类的代码 ...

// 1.2秒后清除保护标记（hintPulse 动画一个循环的时间）
setTimeout(() => {
  if (bottomHandEl) {
    bottomHandEl.dataset.adjusting = "";
  }
}, 1200);
```

---

## 6. 动画时序图

```
完整流程（总时长：100 + 180 + 动态duration）

0ms                100ms              280ms         280+duration
│────────────────────│──────────────────│──────────────│
背景渐显开始         第二阶段开始        第三阶段开始   动画结束
合拢+向左30px       向左到100px         甩回抽1中心    抽卡界面显示
旋转-30°            旋转-100°           旋转-90°
ease-in             ease-out            ease-out
                                                      ↓
                                                   卡组从抽1
                                                   位置炸开
                                                   (420ms)
```

---

## 恢复方法

1. **复制 `animateUpstreamRotateAndOpen` 函数**到 ui.js 的3058-3233行位置
2. **复制 `.drawBack` CSS规则**到 styles.css 的949-966行位置
3. **确保点击事件**调用 `animateUpstreamRotateAndOpen(fromIdx)`（4386行）
4. **确保 closeDrawOverlay**只调用 `renderSeats(game)`（3603-3606行）
5. **确保提示保护机制**已添加到 clearHintHighlight 和 maybeShowHint

---

## 关键特性

✅ **蓄力弧线**：第一+第二阶段形成连贯的ease-in → ease-out弧线
✅ **动态速度**：第三阶段根据距离自动调整时长（80-300ms）
✅ **实时位置**：第三阶段开始时重新获取抽1的最新坐标
✅ **背景效果**：65%黑色 + 6px模糊 + 300ms渐显
✅ **卡组炸开**：抽卡界面卡片从抽1位置展开（420ms）
✅ **提示保护**：使用 data-adjusting 机制防止AI出牌打断

---

**备份完成！** 你可以随时参考这个文档恢复动画。
