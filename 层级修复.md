# 飞行卡牌层级修复（z-index）

## 问题描述

AI 配对出牌时，飞行的卡牌 `z-index` 设置为 `10005`，过高导致：
- **遮挡 UI 按钮**：匹配出牌、提示、结束回合按钮被遮挡
- **遮挡弹出层**：各种弹窗和覆盖层被飞行卡牌遮挡
- **视觉不协调**：卡牌飞行时不应该在最上层

## 层级结构对比

### 修复前（错误）

```
z-index 层级：
10050  jokerRevealOverlay（大王卡特效）
10005  飞行卡牌 ❌ 太高！
10003  upstreamHandGhost
10002  drawOverlay
10001  tunerPanel
10000  endOverlay
9999   flyingCard（正常飞行）
100    gamePanel（全屏横屏模式）
50     zone-bottom .yourHand（玩家手牌）
40     zone-bottom（玩家区域）
30     uiActionBar（按钮）
20     zone-center（弃牌堆）
10     zoneHead, drawRow
1      zone（AI 区域）
```

**问题**：飞行卡牌（10005）比按钮（30）和弹出层（10000+）都高，遮挡了所有内容。

### 修复后（正确）

```
z-index 层级：
10050  jokerRevealOverlay（大王卡特效）
10003  upstreamHandGhost
10002  drawOverlay
10001  tunerPanel
10000  endOverlay
9999   flyingCard（正常飞行）
100    飞行卡牌 ✅ 合理位置
100    gamePanel（全屏横屏模式）
50     zone-bottom .yourHand（玩家手牌）
40     zone-bottom（玩家区域）
30     uiActionBar（按钮）
20     zone-center（弃牌堆）
10     zoneHead, drawRow
1      zone（AI 区域）
```

**效果**：飞行卡牌（100）在游戏元素层，不遮挡按钮和弹出层。

---

## 修复内容

### 1. 发牌阶段初始配对动画

**文件**：`src/ui.js`
**函数**：`startInitialPairingAnimation()`
**行数**：约 2126

```diff
  flyingCard.style.left = `${fromRect.left + ...}px`;
  flyingCard.style.top = `${fromRect.top + ...}px`;
- flyingCard.style.zIndex = "10005";
+ flyingCard.style.zIndex = "100"; // 低层级，不遮挡UI
  flyingCard.style.pointerEvents = "none";
```

### 2. AI 回合配对出牌动画

**文件**：`src/ui.js`
**函数**：`animateAiDiscardPair()`
**行数**：约 610

```diff
  flipContainer.style.left = `${fromRect.left + ...}px`;
  flipContainer.style.top = `${fromRect.top + ...}px`;
- flipContainer.style.zIndex = "10005";
+ flipContainer.style.zIndex = "100"; // 低层级，不遮挡UI
  flipContainer.style.pointerEvents = "none";
```

---

## 为什么选择 z-index: 100？

### 原因分析

1. **高于游戏区域**（1-50）：
   - zone（1）
   - zone-center（20）
   - uiActionBar（30）
   - zone-bottom（40）
   - yourHand（50）

   → 飞行卡牌需要在这些元素**上方**，避免被遮挡

2. **低于 UI 覆盖层**（9999+）：
   - flyingCard（9999）
   - endOverlay（10000）
   - tunerPanel（10001）
   - drawOverlay（10002）

   → 飞行卡牌应该在这些元素**下方**，避免遮挡用户操作

3. **与全屏模式一致**（100）：
   - gamePanel 全屏模式（100）

   → 使用相同层级，保持一致性

### 结论

`z-index: 100` 是最佳选择：
- ✅ 不被游戏元素遮挡
- ✅ 不遮挡 UI 按钮和弹窗
- ✅ 与全屏模式层级一致

---

## 视觉效果对比

### 修复前（z-index: 10005）

```
用户点击"匹配出牌"
  ↓
AI 开始配对出牌
  ↓
卡牌飞行中...
  🎴 ← 飞行卡（z-index 10005）
  ↓
[匹配出牌] [提示] [结束回合] ← 按钮被遮挡！
  ↓
用户看不到按钮
```

### 修复后（z-index: 100）

```
用户点击"匹配出牌"
  ↓
AI 开始配对出牌
  ↓
[匹配出牌] [提示] [结束回合] ← 按钮可见
  ↓
卡牌飞行中...
  🎴 ← 飞行卡（z-index 100，在按钮下方）
  ↓
用户可以正常操作
```

---

## 影响范围

### 修改的动画

1. **发牌阶段初始配对**：
   - AI 玩家在发牌后自动出初始配对
   - 多对同时飞向弃牌堆

2. **AI 回合配对出牌**：
   - AI 在回合中发现配对后出牌
   - 使用物理动画（抛物线 + 翻滚）

### 不影响的动画

- ✅ 玩家出牌动画（`flyToDiscard`）- 使用 flyingCard class
- ✅ 抽牌动画（`animateDrawCardFly`）- 有自己的层级
- ✅ 大王卡特效（`jokerRevealOverlay`）- z-index 10050

---

## 测试验证

### 测试步骤

1. 启动游戏：http://127.0.0.1:8000/english-old-maid/
2. 开始游戏，观察发牌阶段：
   - AI 初始配对飞行时，UI 按钮应该**可见**
   - 卡牌不应遮挡顶部标题栏

3. 等待 AI 回合配对出牌：
   - 飞行卡牌不应遮挡按钮
   - 可以正常点击"提示"、"匹配出牌"等按钮

4. 打开调布局面板（如果卡牌正在飞行）：
   - 调布局面板应该在飞行卡牌**上方**
   - 不被飞行卡牌遮挡

### 预期结果

- ✅ 飞行卡牌在游戏区域正常显示
- ✅ UI 按钮和弹窗不被遮挡
- ✅ 视觉层次合理，用户体验流畅

---

## 相关文件

- `src/ui.js` - 主修复逻辑
- `styles.css` - CSS 层级定义
- `AI配对出牌动画说明.md` - 物理动画文档
- `AI自动配对修复.md` - 自动配对逻辑

---

**更新时间**：2026-01-11
**版本**：v3.3 - Z-Index Fix for Flying Cards
