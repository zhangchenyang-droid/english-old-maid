# 当前简化版玩上抽卡动画备份

**备份时间**：2026-01-13 20:50
**版本**：简化版（按下聚合+替换，松手打开界面）

---

## 当前实现的 animateUpstreamRotateAndOpen 函数

**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约3093-3141行

```javascript
// 上家手牌动画
function animateUpstreamRotateAndOpen(fromIdx) {
  const upstream = game.players[fromIdx];
  if (!upstream || upstream.hand.length === 0) {
    openDrawOverlay(fromIdx);
    return;
  }

  const handEl = seatHandElByPlayerIndex(fromIdx);
  const backs = Array.from(handEl.querySelectorAll(".miniBack"));
  if (backs.length === 0) {
    openDrawOverlay(fromIdx);
    return;
  }

  // 边界情况：只有1张牌，直接打开抽牌界面
  if (backs.length === 1) {
    openDrawOverlay(fromIdx);
    return;
  }

  // 快速过渡：80ms完成动画（不淡出，不显示背景）
  backs.forEach(card => {
    card.style.transition = 'left 80ms ease-out, top 80ms ease-out, transform 80ms ease-out';
  });

  requestAnimationFrame(() => {
    // 获取第一张牌的基础旋转角度
    const bottomCard = backs[0];
    const targetSrot = bottomCard.style.getPropertyValue('--srot') || '0deg';
    const targetRotValue = parseFloat(targetSrot);

    backs.forEach(card => {
      // 聚合到中心点（0, 0），即手牌区域的中心
      card.style.setProperty('--sx', '0px');
      card.style.setProperty('--sy', '0px');

      // 逆时针旋转90度 + 缩小到90%
      const newRot = targetRotValue - 90;
      card.style.transform = `translate(-50%, -50%) rotate(${newRot}deg) scale(0.9)`;
    });

    // 80ms后，将最上面的牌替换成抽1卡背样式，并隐藏其他手牌
    setTimeout(() => {
      const topCard = backs[backs.length - 1]; // 最后一张（z-index最高）

      // 隐藏所有手牌（除了最上面的）
      backs.forEach((card, idx) => {
        if (idx !== backs.length - 1) {
          card.style.opacity = '0';
        }
      });

      // 将最上面的牌改为抽1的视觉样式（不改className，保持定位）
      if (topCard) {
        // 保持miniBack的position定位，只改视觉
        topCard.style.setProperty('border-radius', '12px', 'important'); // 适中的圆角
        topCard.style.setProperty('border', '1px solid rgba(255,255,255,0.22)', 'important'); // 抽1的边框
        // 背景图已经是card-back.png，无需修改
      }
    }, 80);
  });

  // 标记动画已完成，等待 pointerup
  setTimeout(() => {
    handEl.dataset.animationComplete = "true";
    handEl.dataset.pendingFromIdx = String(fromIdx);
  }, 80);
}
```

---

## 事件监听器

### pointerdown 事件
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约4276-4290行

```javascript
// Click upstream backs to draw
document.addEventListener("pointerdown", (e) => {
  const b = e.target.closest(".seatHand[data-from-player-index]");
  if (!b) return;
  if (!game || game.gameOver) return;
  const current = game.players[game.currentPlayerIndex];
  if (current.kind !== "human") return;
  const fromIdx = Number(b.dataset.fromPlayerIndex);
  markHumanAction();

  // 触发甩卡动画（鼠标按下瞬间触发）
  animateUpstreamRotateAndOpen(fromIdx);
});
```

### pointerup 事件
**文件**：`/Users/karnoz/english-old-maid/src/ui.js`
**行号**：约4292-4327行

```javascript
// 监听 pointerup 事件，松手时显示背景和打开抽牌界面
document.addEventListener("pointerup", (e) => {
  const b = e.target.closest(".seatHand[data-from-player-index]");
  if (!b) return;
  if (b.dataset.animationComplete !== "true") return;

  const fromIdx = Number(b.dataset.pendingFromIdx);

  // 清除标记
  b.dataset.animationComplete = "";
  b.dataset.pendingFromIdx = "";

  // 显示背景变暗+模糊
  const drawOverlay = document.getElementById("drawOverlay");
  if (drawOverlay) {
    drawOverlay.classList.remove("hidden");
    drawOverlay.style.background = "rgba(0,0,0,0.65)";
    drawOverlay.style.backdropFilter = "blur(6px)";
    drawOverlay.style.transition = "opacity 300ms ease-out, backdrop-filter 300ms ease-out";
    drawOverlay.style.opacity = "0";

    requestAnimationFrame(() => {
      drawOverlay.style.opacity = "1";
    });
  }

  // 打开抽牌界面
  openDrawOverlay(fromIdx);

  // 隐藏玩上手牌并清理样式
  const backs = Array.from(b.querySelectorAll(".miniBack"));
  backs.forEach(card => {
    card.style.opacity = '0';
    card.style.transition = '';
    card.style.transform = '';
  });
});
```

---

## 动画特性

### 时序
```
pointerdown（按下）
    ↓ 0ms
聚合动画（80ms）
  - 聚合到中心点
  - 逆时针旋转90度
  - 缩小到90%
    ↓ 80ms
同时：
  - 隐藏除最上面外的所有手牌
  - 最上面的牌改为抽1视觉
    圆角：12px
    边框：rgba(255,255,255,0.22)
    ↓
玩家按住...
    ↓
pointerup（松手）
    ↓
显示背景（300ms渐显）
打开抽牌界面
隐藏所有手牌
清理样式
```

### 参数

- **聚合时长**：80ms
- **缓动函数**：ease-out
- **旋转角度**：-90度
- **缩放比例**：0.9
- **圆角**：12px
- **背景渐显**：300ms

---

## 恢复方法

1. 复制上面的 `animateUpstreamRotateAndOpen` 函数到 ui.js
2. 复制 pointerdown 事件监听器
3. 复制 pointerup 事件监听器
4. 刷新浏览器测试

---

**备份状态**：已保存
**可恢复性**：✅ 完整
