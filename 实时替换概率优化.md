# 实时替换概率优化

## 问题诊断

从控制台日志发现：
```
[实时替换] consecutiveNoMatch:0 概率:40% 骰子:74% 触发:false
[实时替换] 未触发（运气不好）
```

**问题**：
- 替换概率只有 40%，太低
- 没有考虑 A/B 不平衡度（当时玩家是 A:1 B:4 -3）
- 结果：60% 的情况不替换，A/B 不平衡持续

---

## 解决方案：动态概率

### 旧版（固定概率）

```javascript
// 只根据连续未匹配次数
if (consecutiveNoMatch === 0) {
  probability = 0.4;  // 40% ❌
}
```

**问题**：
- 忽略了 A/B 平衡状态
- 即使严重不平衡（-5），概率也只有 40%

---

### 新版（动态概率）

```javascript
// 1️⃣ 基础概率（根据连续未匹配次数）
baseProbability = 0.6 ~ 0.95

// 2️⃣ A/B 不平衡加成
balanceBonus = (abDiff - 1) * 10%

// 3️⃣ 最终概率
finalProbability = min(100%, base + bonus)
```

---

## 概率计算表

### 基础概率（连续未匹配）

| consecutiveNoMatch | 旧版 | 新版 | 提升 |
|-------------------|------|------|------|
| 0（上次成功）| 40% | **60%** | +20% |
| 1（连续1次失败）| 60% | **80%** | +20% |
| 2+（连续2次以上）| 85% | **95%** | +10% |

### A/B 不平衡加成

| A/B 差异 | 加成 | 说明 |
|---------|------|------|
| 0-1 | 0% | 均衡，无需加成 |
| 2 | +10% | 轻度不平衡 |
| 3 | +20% | 中度不平衡 |
| 4 | +30% | 严重不平衡 |
| 5+ | +30% | 极度不平衡（封顶） |

### 综合示例

**场景 1：严重不平衡 + 连续失败**

```
玩家手牌：A:1 B:6 差异:5
consecutiveNoMatch = 1

基础概率：80%
平衡加成：+30%（差异 5）
最终概率：100%（封顶）✅

结果：必定触发替换！
```

**场景 2：轻度不平衡 + 上次成功**

```
玩家手牌：A:3 B:2 差异:1
consecutiveNoMatch = 0

基础概率：60%
平衡加成：0%（差异 1）
最终概率：60%

结果：60% 概率触发替换
```

**场景 3：中度不平衡 + 首次抽牌**

```
玩家手牌：A:1 B:4 差异:3
humanFirstDrawInGame = true

基础概率：70%
平衡加成：+20%（差异 3）
最终概率：90%

结果：90% 概率触发替换！
```

---

## 对比你的实际情况

### 你刚才的抽牌

**状态**：
- 手牌：A:1 B:4 差异:3
- consecutiveNoMatch: 0

**旧版计算**：
```
概率 = 40%
骰子 = 74%
结果 = 未触发 ❌
```

**新版计算**：
```
基础概率 = 60%
平衡加成 = +20%（差异 3）
最终概率 = 80%
骰子 = 74%
结果 = 触发！✅
```

---

## 新日志格式

现在控制台会显示：

```
[实时替换] A:1 B:4 差异:3 基础:60% 平衡加成:+20% 最终:80% 骰子:74% 触发:true
[实时替换] 第3张牌不可匹配，寻找替换...
[平衡] 玩家手牌 A:1 B:4 差异:3 需要:A
[实时替换] 成功！换入 A 侧牌 5（优先级:10）
→ 抽牌后：A:2 B:4 差异:2（改善了！）
```

---

## 预期效果

### 短期（单次抽牌）

- 差异 3 → 80% 概率替换
- 如果触发，差异改善：3 → 2 或 3 → 1

### 长期（多轮游戏）

- 差异逐渐收敛到 0-2
- 很少出现差异 4+ 的情况
- 游戏体验更流畅

---

## 概率对比表（完整）

| 场景 | 差异 | noMatch | 旧版 | 新版 |
|------|------|---------|------|------|
| 均衡，上次成功 | 1 | 0 | 40% | 60% |
| 轻度不平衡 | 2 | 0 | 40% | **70%** |
| 中度不平衡 | 3 | 0 | 40% | **80%** |
| 严重不平衡 | 4 | 0 | 40% | **90%** |
| 极度不平衡 | 5+ | 0 | 40% | **90%** |
| 中度不平衡 + 连续失败 | 3 | 1 | 60% | **100%** |
| 严重不平衡 + 连续失败 | 4 | 2 | 85% | **100%** |

---

## 测试方法

1. **刷新页面，重新开始游戏**
2. **观察你的手牌 A/B 分布**（界面右下角显示）
3. **抽牌时打开控制台**（F12）
4. **查看日志**：
   ```
   [实时替换] A:1 B:4 差异:3 基础:60% 平衡加成:+20% 最终:80% ...
   ```

5. **验证**：
   - 差异越大，概率越高
   - 触发替换后，差异应该减小
   - 几轮后差异应该收敛到 0-2

---

## 相关文件

- `src/ui.js` - 实时替换逻辑（第 2959-2990 行）
- `src/game.js` - AI 抽牌平衡逻辑
- `AI抽牌平衡机制.md` - AI 抽牌策略

---

**更新时间**：2026-01-12
**版本**：v5.2 - Dynamic Replacement Probability
